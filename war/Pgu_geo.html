<!doctype html>
<html>
  <head>
    <!-- before your module(*.nocache.js) loading  -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if IE 7]>
    <link rel="stylesheet" href="pgu_geo/css/font-awesome-ie7.css">
    <![endif]-->
    <!-- your module(*.nocache.js) loading  -->
  
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    
    <link rel="icon" type="image/png" href="/img/favicon_globe.png" />
    <!--[if IE]><link rel="shortcut icon" type="image/x-icon" href="/img/favicon_globe.png" /><![endif]-->      
    
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
    </style>
    <link type="text/css" rel="stylesheet" href="Pgu_geo.css">
    
    <title>Geo</title>
    
    <script type="text/javascript" src="pgu_geo/pgu_geo.nocache.js"></script>

    <script type="text/javascript">
    
        var pgu_geo_is_user_already_logged = false;    
        
        function pgu_geo_add_load_event(fn) {
            var old_onload = window.onload;
            
            if (typeof window.onload !== 'function') {
                window.onload = fn;
                
            } else {
                window.onload = function() {
                    if (old_onload) {
                        old_onload();
                    }
                    
                    fn();
                }
            }
        }

        function pgu_geo_charts_callback() {
        	console.log('pgu_geo_charts_callback');
            
            if (typeof pgu_geo === 'undefined') {
                setTimeout(
                    function() {
                    	pgu_geo_charts_callback();
                    }
                    , 1000
                );
                return;
            }
            
            pgu_geo.init_charts();          
        }

        function pgu_geo_load_charts_api_callback() {
        	console.log('pgu_geo_load_charts_api_callback');
            google.load('visualization', '1.0', {'packages': ['geochart', 'corechart'], 'callback':pgu_geo_charts_callback});
        }

        function pgu_geo_load_map_api_callback() {
        	console.log('pgu_geo_load_map_api_callback');
        	
            if (typeof pgu_geo === 'undefined') {
                setTimeout(
                    function() {
                        pgu_geo_load_map_api_callback();
                    }
                    , 1000
                );
                return;
            }
            
            pgu_geo.init_geo();         
        }

        function pgu_geo_load_script(url, innerHTML, callback) {
        	console.log('pgu_geo_load_script ' + url);
        	
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = url;
            return script;
        }
        
        function pgu_geo_load_external_scripts() {
        	console.log('pgu_geo_load_external_scripts');
        	
        	var showdown_script = pgu_geo_load_script('js/showdown.js');
        	var maps_script = pgu_geo_load_script('http://maps.googleapis.com/maps/api/js?key=AIzaSyAJLUd4j8dQFHAuD2gy9Fr60ZR1IDVaGnE&sensor=false&callback=pgu_geo_load_map_api_callback');
        	var charts_script = pgu_geo_load_script('https://www.google.com/jsapi?callback=pgu_geo_load_charts_api_callback');
        	
        	showdown_script.onreadystatechange = function() {  
                if (this.readyState === 'complete' || this.readyState === 'loaded') {  
                    pgu_geo.showdown_is_available();   
                }  
            };   
            showdown_script.onload = pgu_geo.showdown_is_available;          	    
        	
            document.body.appendChild(showdown_script);
            document.body.appendChild(maps_script);
            document.body.appendChild(charts_script);

        }

        function pgu_geo_on_profile_load(profiles) {
            console.log('pgu_geo_on_profile_load');
            console.log(profiles); 
            
            var member = profiles.values[0];
            var msg = member.id + ", Hello " +  member.firstName + " " + member.lastName;
            console.log(msg); 
        }       
        
        function pgu_geo_on_connections_load(connections) {
            console.log('pgu_geo_on_connections_load');
            console.log(connections); 
        }  

        function pgu_geo_on_linkedin_auth() {
            console.log('pgu_geo_on_linkedin_auth');
            
            if (!pgu_geo_is_user_already_logged) {
                pgu_geo.is_logged_in();
            }
            
            IN.API.Profile("me")
            .fields(
                    "id" //
                    , "first-name" //
                    , "last-name" //
                    , "headline" //
                    , "location" //
                    , "numConnections" //
                    , "numConnectionsCapped" //
                    , "summary" //
                    , "specialties" //
                    , "pictureUrl" //
                    , "publicProfileUrl" //
                    , "positions:(id,company,endDate,isCurrent,startDate,summary,title,location)" //
                    , "languages:(language,proficiency)" //
                    , "educations" //
            )
            .result(pgu_geo_on_profile_load);
          
            IN.API.Connections("me")
            .fields("firstName", "lastName", "location")
            .result(pgu_geo_on_connections_load);
        }

        function pgu_geo_on_linkedin_load() {
            console.log('pgu_geo_on_linkedin_load');
            
            var is_user_logged_in = IN.User.isAuthorized(); 
            
            pgu_geo_is_user_already_logged = is_user_logged_in; 
            
            console.log(is_user_logged_in);

            if (is_user_logged_in) {
                pgu_geo.is_logged_in();
            } else {
                pgu_geo.is_logged_out();
            }
            
            IN.Event.on(IN, "auth", pgu_geo_on_linkedin_auth);
        }

        function pgu_geo_load_linkedin_api() {
            console.log('pgu_geo_load_linkedin_api');
            
            var linkedin_script = pgu_geo_load_script('http://platform.linkedin.com/in.js');
            linkedin_script.innerHTML = '/* \n' + //
                      'api_key: qwfxh7u2673i \n' + //
                      'authorize: true \n' + //
                      'scope: r_fullprofile r_network \n' + //
                      'onLoad: pgu_geo_on_linkedin_load \n' + //
                      '*/ \n';
            
            document.body.appendChild(linkedin_script);
        }
        
        var pgu_geo_is_public_view = window.location.hash.indexOf('#!public:') === 0; 
        
        if (pgu_geo_is_public_view) {
          console.log("is public");
          // load the gwt application -> the public view
        
        } else {
            console.log("is application");
            // load linkedin api
            // then load the gwt application
            //    inside the gwt application: if the user is logged then show the current place
            //                                else show the signin view
            
            // https://developer.linkedin.com/documents/javascript-api-tutorial
            pgu_geo_add_load_event(pgu_geo_load_linkedin_api);
        }
    
    </script>    
  </head>
  <body>
    <iframe src="javascript:''" id="__gwt_historyFrame" tabIndex='-1' style="position:absolute;width:0;height:0;border:0"></iframe>
    <noscript>
      <div style="width: 22em; position: absolute; left: 50%; margin-left: -11em; color: red; background-color: white; border: 1px solid red; padding: 4px; font-family: sans-serif">
        Your web browser must have JavaScript enabled
        in order for this application to display correctly.
      </div>
    </noscript>

<!--     <script type="IN/Login"></script> -->
    
<!--     <script type="in/Login"> -->
<!--        Hello, <?js= firstName ?> <?js= lastName ?>. -->
<!--     </script> -->

<!--     <script type="IN/Login" data-onAuth="onLinkedInAuth"></script> -->
  </body>
</html>
